<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Animal Kingdom Casino V2</title>

<style>
*{
  box-sizing:border-box;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select:none;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:#0d0d18;
  color:white;
  overflow-x:hidden;
}
header{
  padding:10px;
  background:#15152a;
  border-bottom:1px solid #222;
  position:sticky; top:0; z-index:50;
}
.topRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.logo{
  font-weight:900;
  cursor:pointer;
  white-space:nowrap;
}
.wallet{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
  font-size:14px;
}
.subRow{
  margin-top:8px;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.badge{
  padding:6px 10px;
  border:1px solid #333;
  border-radius:999px;
  background:#10102a;
  font-size:13px;
  color:#d6d6ff;
}
.expWrap{
  flex:1;
  min-width:180px;
}
.expBar{
  width:100%;
  height:10px;
  background:#2a2a44;
  border-radius:999px;
  overflow:hidden;
  border:1px solid #333;
}
.expFill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#2bd6ff,#a86bff);
  transition:width 0.25s;
}
.expText{
  margin-top:4px;
  font-size:12px;
  color:#b9b9dd;
  display:flex;
  justify-content:space-between;
}
.main{
  padding:15px;
  max-width:720px;
  margin:0 auto;
}
.screen{
  display:none;
}
.screen.active{
  display:block;
}
.card{
  background:#12122a;
  border:1px solid #2a2a44;
  border-radius:14px;
  padding:12px;
  margin:10px 0;
}
h2,h3{ margin:8px 0 10px; }
button{
  padding:10px 12px;
  margin:6px 6px 0 0;
  font-size:16px;
  background:#222;
  color:white;
  border:1px solid #444;
  border-radius:12px;
}
button:active{
  transform:scale(0.97);
  box-shadow:0 0 15px rgba(43,214,255,0.6);
}
.smallBtn{ font-size:14px; padding:8px 10px; border-radius:10px; }
.hidden{ display:none; }

.hpbar{
  width:100%;
  height:18px;
  background:#333;
  border-radius:999px;
  overflow:hidden;
  border:1px solid #444;
  margin-top:8px;
}
.hpfill{
  height:100%;
  background:linear-gradient(90deg,#ff4d6d,#ffb703);
  width:100%;
  transition:width 0.25s;
}

.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#000;
  padding:10px 14px;
  border:1px solid #555;
  border-radius:14px;
  z-index:9999;
  font-size:14px;
  max-width:90vw;
  opacity:0;
  transition:opacity 0.15s;
}
.toast.show{ opacity:0.92; }
.toast.good{ border-color:#2aff9a; }
.toast.bad{ border-color:#ff4d6d; }

.modalBack{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9998;
  padding:16px;
}
.modalBack.show{ display:flex; }
.modal{
  width:min(520px, 95vw);
  background:#0f0f1f;
  border:1px solid #2a2a44;
  border-radius:16px;
  padding:14px;
}
.modal h3{ margin:0 0 8px; }
.modal .desc{ color:#cfcfe9; font-size:14px; line-height:1.4; }
.modal .reward{ margin-top:10px; color:#9ef; font-size:14px; }
.modal .row{ display:flex; gap:8px; margin-top:12px; justify-content:flex-end; }

.achList{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.achItem{
  padding:10px;
  border:1px solid #2a2a44;
  border-radius:12px;
  background:#10102a;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
}
.achName{ font-weight:800; }
.achDesc{ font-size:13px; color:#c7c7e6; margin-top:2px; }
.achRight{ font-size:12px; color:#a8a8c7; white-space:nowrap; }
.floating{
  position:fixed;
  pointer-events:none;
  z-index:9997;
  animation:floatUp 1s ease-out forwards;
}
@keyframes floatUp{
  0%{ opacity:1; transform:translate(-50%,0) scale(1); }
  100%{ opacity:0; transform:translate(-50%,-60px) scale(1.05); }
}
</style>
</head>

<body>

<header>
  <div class="topRow">
    <div class="logo" id="logo">ğŸ¾ Animal Casino ğŸ‘‘</div>
    <div class="wallet">
      <div>ğŸ’° <span id="gold">0</span></div>
      <div>ğŸ’ <span id="gems">0</span></div>
      <div>ğŸŸï¸ <span id="tickets">0</span></div>
    </div>
  </div>

  <div class="subRow">
    <div class="badge">Lv <span id="level">1</span></div>
    <div class="expWrap">
      <div class="expBar"><div class="expFill" id="expFill"></div></div>
      <div class="expText">
        <span id="expText">EXP 0 / 50</span>
        <span id="feverText">Fever 0%</span>
      </div>
    </div>
    <button class="smallBtn" onclick="go('progress')">ğŸ“Œ ì§„í–‰/ì—…ì </button>
  </div>
</header>

<div class="main">

  <!-- LOBBY -->
  <div id="lobby" class="screen active">
    <div class="card">
      <h2>ğŸ  ë¡œë¹„</h2>
      <button onclick="go('clicker')">ğŸ’° í´ë¦­ì»¤</button>
      <button onclick="go('slot')">ğŸ° ìŠ¬ë¡¯</button>
      <button onclick="go('shop')">ğŸ›’ ìƒì </button>
      <button onclick="go('inventory')">ğŸ’ ì°½ê³ </button>
      <button onclick="go('battle')">âš” ì „íˆ¬</button>
    </div>

    <div class="card">
      <h3>ğŸ”¥ ì˜¤ëŠ˜ì˜ ì¶”ì²œ ë£¨í”„</h3>
      <div style="color:#cfcfe9;font-size:14px;line-height:1.5">
        1) í´ë¦­ì»¤ë¡œ ğŸ’° ëª¨ìœ¼ê¸° â†’ 2) ìŠ¬ë¡¯ìœ¼ë¡œ ë²„í”„/ì­íŒŸ â†’ 3) ì „íˆ¬ë¡œ ë³´ìƒ â†’ 4) ìƒì  ê°•í™” â†’ ë°˜ë³µ
      </div>
    </div>
  </div>

  <!-- CLICKER -->
  <div id="clicker" class="screen">
    <div class="card">
      <h2>ğŸ’° í´ë¦­ì»¤</h2>
      <button onclick="clickGold(event)">ğŸ’° íƒ­</button>
      <div style="margin-top:8px;color:#cfcfe9">
        ìë™ìˆ˜ìµ: <b><span id="idleRate">0</span></b> /ì´ˆ
      </div>
      <button onclick="buyIdle()">ìë™ ì—…ê·¸ë ˆì´ë“œ</button>
      <div style="margin-top:10px;color:#a8a8c7;font-size:13px">
        í¬ë¦¬í‹°ì»¬ í™•ë¥ : <span id="critText">10%</span>
      </div>
      <button class="smallBtn" onclick="go('lobby')">â¬… ë¡œë¹„</button>
    </div>
  </div>

  <!-- SLOT -->
  <div id="slot" class="screen">
    <div class="card">
      <h2>ğŸ° ìŠ¬ë¡¯</h2>
      <button onclick="spinSlot()">100ğŸ’° ëŒë¦¬ê¸°</button>
      <button class="smallBtn" onclick="spinSlot(10)">10íšŒ (900ğŸ’°)</button>
      <div id="slotResult" style="margin-top:10px;font-size:22px"></div>
      <div style="margin-top:8px;color:#a8a8c7;font-size:13px">
        3ê°œ ì¼ì¹˜ ì‹œ ë³´ìƒ + ì´í™íŠ¸. ğŸ”¥ğŸ”¥ğŸ”¥ = 10ì´ˆ ë”ë¸”, ğŸ‘‘ğŸ‘‘ğŸ‘‘ = ëŒ€ë°•
      </div>
      <button class="smallBtn" onclick="go('lobby')">â¬… ë¡œë¹„</button>
    </div>

    <div class="card">
      <h3>ğŸ² ë™ë¬¼ ê°€ì± </h3>
      <button onclick="drawGacha()">1íšŒ (300ğŸ’°)</button>
      <button class="smallBtn" onclick="drawGacha(10)">10íšŒ (2700ğŸ’°)</button>
      <div id="gachaResult" style="margin-top:10px;color:#cfcfe9"></div>
      <div style="margin-top:6px;color:#a8a8c7;font-size:13px">
        SR ì´ìƒ 10ì—° ë³´ì¥, SSR ì²œì¥ 80
      </div>
      <button class="smallBtn" onclick="go('lobby')">â¬… ë¡œë¹„</button>
    </div>
  </div>

  <!-- SHOP -->
  <div id="shop" class="screen">
    <div class="card">
      <h2>ğŸ›’ ìƒì </h2>
      <div style="color:#cfcfe9;font-size:14px;line-height:1.55">
        ê°•í™”ëŠ” ì˜êµ¬ ì ìš©. ì„±ì¥ ì²´ê° í¬ê²Œ ì£¼ê¸°.
      </div>
      <button onclick="buyCrit()">í¬ë¦¬ í™•ë¥  +1% (500ğŸ’°)</button>
      <button onclick="buyFeverBoost()">í”¼ë²„ ì¶©ì „ +20% (800ğŸ’°)</button>
      <button onclick="buyBattleBoost()">ì „íˆ¬ ë³´ìƒ +10% (700ğŸ’°)</button>
      <div style="margin-top:10px;color:#a8a8c7;font-size:13px">
        í”¼ë²„ ì¶©ì „ ë³´ë„ˆìŠ¤: <span id="feverBoostText">0%</span><br>
        ì „íˆ¬ ë³´ìƒ ë³´ë„ˆìŠ¤: <span id="battleBoostText">0%</span>
      </div>
      <button class="smallBtn" onclick="go('lobby')">â¬… ë¡œë¹„</button>
    </div>
  </div>

  <!-- INVENTORY -->
  <div id="inventory" class="screen">
    <div class="card">
      <h2>ğŸ’ ì°½ê³ </h2>
      <div style="color:#a8a8c7;font-size:13px;margin-bottom:8px">
        ë™ë¬¼ ì¥ì°© ì‹œ íŒ¨ì‹œë¸Œ ì ìš© (í´ë¦­/ì „íˆ¬ ë³´ë„ˆìŠ¤)
      </div>
      <div id="equippedBox" class="card" style="background:#10102a;margin:0 0 10px">
        ì¥ì°©: <b id="equippedText">ì—†ìŒ</b>
      </div>
      <div id="inventoryList">ë¹„ì–´ ìˆìŒ</div>
      <button class="smallBtn" onclick="go('lobby')">â¬… ë¡œë¹„</button>
    </div>
  </div>

  <!-- BATTLE -->
  <div id="battle" class="screen">
    <div class="card">
      <h2>âš” ì „íˆ¬</h2>
      <button onclick="battle()">ì „íˆ¬ ì‹œì‘</button>
      <div class="hpbar"><div id="enemyHP" class="hpfill"></div></div>
      <div id="battleLog" style="margin-top:10px;color:#cfcfe9"></div>
      <div style="margin-top:6px;color:#a8a8c7;font-size:13px">
        ìŠ¹ë¦¬ ë³´ìƒ: ğŸ’° + EXP + (ë‚®ì€ í™•ë¥ ë¡œ ğŸŸï¸/ğŸ’)
      </div>
      <button class="smallBtn" onclick="go('lobby')">â¬… ë¡œë¹„</button>
    </div>
  </div>

  <!-- PROGRESS / ACHIEVEMENTS -->
  <div id="progress" class="screen">
    <div class="card">
      <h2>ğŸ“Œ ì§„í–‰ / ì—…ì </h2>
      <div style="color:#cfcfe9;font-size:14px;line-height:1.55">
        ìˆ¨ê²¨ì§„ ì—…ì ì€ ë‹¬ì„± ì „ê¹Œì§€ <b>???</b>ë¡œ ë³´ì„. ë‹¬ì„±í•˜ë©´ ì •ì²´ ê³µê°œ + ë³´ìƒ ì§€ê¸‰.
      </div>

      <div style="margin-top:12px;color:#a8a8c7;font-size:13px">
        ëˆ„ì  í´ë¦­: <span id="statClicks">0</span> / í¬ë¦¬: <span id="statCrits">0</span> / ìŠ¬ë¡¯: <span id="statSlots">0</span> / ì­íŒŸ: <span id="statJackpots">0</span><br>
        ì „íˆ¬ ìŠ¹ë¦¬: <span id="statWins">0</span> / ëˆ„ì  íšë“ ê³¨ë“œ: <span id="statGoldTotal">0</span>
      </div>

      <h3 style="margin-top:14px">ğŸ† ì—…ì </h3>
      <div id="achList" class="achList"></div>

      <button class="smallBtn" onclick="go('lobby')">â¬… ë¡œë¹„</button>
    </div>
  </div>

  <!-- DEV PANEL (hidden gate) -->
  <div id="devPanel" class="screen hidden">
    <div class="card">
      <h2>ğŸ§ª ê´€ë¦¬ì íŒ¨ë„</h2>
      <button onclick="cheatAddGold(100000)">+100000ğŸ’°</button>
      <button onclick="cheatAddGems(1000)">+1000ğŸ’</button>
      <button onclick="cheatAddTickets(100)">+100ğŸŸï¸</button>
      <button onclick="cheatForceJackpot()">ìŠ¬ë¡¯ ğŸ‘‘ğŸ‘‘ğŸ‘‘</button>
      <button onclick="cheatForceSSR()">ê°€ì±  SSR</button>
      <button onclick="cheatReset()">ë°ì´í„° ì´ˆê¸°í™”</button>
      <button class="smallBtn" onclick="go('lobby')">â¬… ë¡œë¹„</button>
    </div>
  </div>

</div>

<div id="toast" class="toast"></div>

<div id="modalBack" class="modalBack" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="modalTitle">Title</h3>
    <div class="desc" id="modalDesc">Desc</div>
    <div class="reward" id="modalReward"></div>
    <div class="row">
      <button class="smallBtn" onclick="hideModal()">í™•ì¸</button>
    </div>
  </div>
</div>

<script>
// ---------------------- CONFIG ----------------------
const CONFIG = {
  clickBase: 1,
  critMulti: 5,

  idleBasePerLevel: 0.5,
  idleBaseCost: 15,
  idleGrowth: 1.4,

  slotCost: 100,
  slotCostTen: 900,

  gachaCost: 300,
  gachaCostTen: 2700,
  gachaRates: { N: 70, R: 25, SR: 4.5, SSR: 0.5 },
  gachaPitySSR: 80,         // hard pity
  gachaGuaranteeSR10: true, // 10-pull guarantee SR+

  feverNeed: 100,
  feverDurationMs: 10000,

  // EXP curve (simple)
  expBaseNeed: 50,      // level 1 -> 2
  expGrowth: 1.25       // nextExp = base * growth^(level-1)
};

// ---------------------- STATE ----------------------
let state = {
  gold: 0,
  gems: 0,
  tickets: 0,

  idleLevel: 0,
  critChance: 0.10,

  fever: 0,
  feverChargeBonus: 0,     // +% charge
  battleRewardBonus: 0,    // +% gold reward

  buffUntil: 0,

  level: 1,
  exp: 0,

  gachaPity: 0,
  gachaSinceSR: 0,

  // inventory
  animals: [],             // {id, name, rarity, emoji, clickBonus, battleBonus}
  equippedAnimalId: null,

  // stats for achievements
  stats: {
    clicks: 0,
    crits: 0,
    slots: 0,
    jackpots: 0,
    battles: 0,
    wins: 0,
    goldEarnedTotal: 0,
    spendTotal: 0,
    gachaPulls: 0
  },

  achievements: {},        // id: true
  lastSave: Date.now()
};

// ---------------------- SAVE/LOAD (with offline gold) ----------------------
function save(){
  state.lastSave = Date.now();
  localStorage.setItem("casinoV2_full", JSON.stringify(state));
}

function load(){
  const raw = localStorage.getItem("casinoV2_full");
  if(!raw) return;

  try{
    const prev = JSON.parse(raw);
    state = { ...state, ...prev };

    // Offline income (cap to avoid insane gains)
    const offlineSec = Math.min(3600 * 8, Math.floor((Date.now() - (state.lastSave || Date.now())) / 1000)); // max 8h
    if(offlineSec > 2){
      const gain = offlineSec * getIdleIncome();
      addGold(gain, {silent:true, source:"offline"});
      toast(`ì˜¤í”„ë¼ì¸ ìˆ˜ìµ +${Math.floor(gain)}ğŸ’°`, "good");
    }
  }catch(e){
    // ignore corrupted save
  }
}
load();

// ---------------------- UI HELPERS ----------------------
const $ = (id)=>document.getElementById(id);

function go(screen){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  $(screen).classList.add("active");
  if(screen === "inventory") renderInventory();
  if(screen === "progress") { renderAchievements(); renderStats(); }
}

function updateUI(){
  $("gold").innerText = Math.floor(state.gold);
  $("gems").innerText = state.gems;
  $("tickets").innerText = state.tickets;
  $("idleRate").innerText = getIdleIncome().toFixed(1);
  $("critText").innerText = Math.round(state.critChance * 100) + "%";
  $("feverText").innerText = `Fever ${Math.min(100, Math.floor(state.fever))}%`;
  $("level").innerText = state.level;

  const need = expNeed(state.level);
  $("expText").innerText = `EXP ${Math.floor(state.exp)} / ${need}`;
  $("expFill").style.width = `${Math.min(100, (state.exp / need) * 100)}%`;

  $("feverBoostText").innerText = `${state.feverChargeBonus}%`;
  $("battleBoostText").innerText = `${state.battleRewardBonus}%`;
}

function toast(msg, type=""){
  const el = $("toast");
  el.className = "toast";
  if(type) el.classList.add(type);
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=> el.classList.remove("show"), 1200);
}

function showModal(title, desc, rewardText=""){
  $("modalTitle").innerText = title;
  $("modalDesc").innerText = desc;
  $("modalReward").innerText = rewardText ? `ë³´ìƒ: ${rewardText}` : "";
  $("modalBack").classList.add("show");
}

function hideModal(){
  $("modalBack").classList.remove("show");
}
function closeModal(e){
  if(e.target.id === "modalBack") hideModal();
}

// Floating text
function floatText(text, x=window.innerWidth/2, y=window.innerHeight/2){
  const el = document.createElement("div");
  el.className = "floating";
  el.innerText = text;
  el.style.left = x + "px";
  el.style.top = y + "px";
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 1000);
}

// Screen shake
function screenShake(ms=140){
  const b = document.body;
  b.style.transition = "transform 0.05s";
  b.style.transform = "translateX(5px)";
  setTimeout(()=> b.style.transform = "translateX(-5px)", 50);
  setTimeout(()=> b.style.transform = "translateX(0px)", ms);
}

// Emoji burst particles
function burst(emoji="âœ¨", n=22){
  for(let i=0;i<n;i++){
    const el = document.createElement("div");
    el.innerText = emoji;
    el.style.position = "fixed";
    el.style.left = "50%";
    el.style.top = "45%";
    el.style.fontSize = "22px";
    el.style.zIndex = 9997;
    const dx = (Math.random()*240 - 120);
    const dy = (Math.random()*240 - 120);
    el.style.transform = `translate(${dx}px, ${dy}px)`;
    el.style.transition = "transform 0.8s ease-out, opacity 0.8s ease-out";
    document.body.appendChild(el);
    requestAnimationFrame(()=>{
      el.style.opacity = "0";
      el.style.transform = `translate(${dx*1.25}px, ${dy*1.25}px)`;
    });
    setTimeout(()=> el.remove(), 900);
  }
}

// ---------------------- ECONOMY HELPERS ----------------------
function getEquipped(){
  if(!state.equippedAnimalId) return null;
  return state.animals.find(a=>a.id === state.equippedAnimalId) || null;
}

function addGold(amount, {silent=false, source=""}={}){
  if(amount <= 0) return;
  state.gold += amount;
  state.stats.goldEarnedTotal += amount;
  if(!silent) floatText(`+${Math.floor(amount)}ğŸ’°`);
  checkAchievements();
  updateUI();
}

function spendGold(amount){
  if(state.gold < amount) return false;
  state.gold -= amount;
  state.stats.spendTotal += amount;
  updateUI();
  return true;
}

// ---------------------- LEVEL / EXP ----------------------
function expNeed(level){
  return Math.floor(CONFIG.expBaseNeed * Math.pow(CONFIG.expGrowth, level - 1));
}

function addExp(amount){
  if(amount <= 0) return;
  state.exp += amount;

  // multi-level
  while(true){
    const need = expNeed(state.level);
    if(state.exp < need) break;
    state.exp -= need;
    state.level++;
    toast(`ë ˆë²¨ ì—…! Lv ${state.level}`, "good");
    burst("ğŸ†", 28);
    screenShake(180);

    // Level up reward
    const bonusGold = 200 + (state.level * 20);
    addGold(bonusGold, {silent:true});
    state.gems += (state.level % 5 === 0) ? 2 : 0; // small gem reward every 5 levels
    showModal(
      `ë ˆë²¨ ì—…! Lv ${state.level}`,
      `ë” ê°•í•´ì¡Œë‹¤. ë ˆë²¨ì—… ë³´ìƒ ì§€ê¸‰.`,
      `+${bonusGold}ğŸ’°${(state.level % 5 === 0) ? " +2ğŸ’" : ""}`
    );
  }
  checkAchievements();
  updateUI();
}

// ---------------------- FEVER ----------------------
function addFever(v){
  const mult = 1 + (state.feverChargeBonus / 100);
  state.fever = Math.min(100, state.fever + v * mult);
  if(state.fever >= CONFIG.feverNeed){
    state.fever = 0;
    state.buffUntil = Date.now() + CONFIG.feverDurationMs;
    toast("í”¼ë²„ ë°œë™! (10ì´ˆ ë”ë¸”)", "good");
    burst("ğŸ”¥", 30);
    screenShake(220);
  }
  updateUI();
}

function isBuffOn(){
  return Date.now() < state.buffUntil;
}

// ---------------------- CLICKER ----------------------
function getIdleIncome(){
  let v = CONFIG.idleBasePerLevel * state.idleLevel;

  // equipped animal passive
  const eq = getEquipped();
  if(eq) v *= (1 + eq.clickBonus);

  if(isBuffOn()) v *= 2;
  return v;
}

function clickGold(e){
  let amt = CONFIG.clickBase;

  // equipped passive
  const eq = getEquipped();
  if(eq) amt *= (1 + eq.clickBonus);

  const crit = Math.random() < state.critChance;
  if(crit){
    amt *= CONFIG.critMulti;
    state.stats.crits++;
    burst("âœ¨", 16);
    screenShake(120);
    floatText(`CRIT x${CONFIG.critMulti}`, e?.clientX || window.innerWidth/2, e?.clientY || window.innerHeight/2);
  }
  state.stats.clicks++;

  if(isBuffOn()) amt *= 2;

  addGold(amt, {silent:true});
  floatText(`+${Math.floor(amt)}ğŸ’°`, e?.clientX || window.innerWidth/2, e?.clientY || window.innerHeight/2);

  addFever(2);
  addExp(1 + (crit ? 2 : 0));
  checkAchievements();
  updateUI();
}

function buyIdle(){
  const cost = Math.floor(CONFIG.idleBaseCost * Math.pow(CONFIG.idleGrowth, state.idleLevel));
  if(!spendGold(cost)){
    toast("ê³¨ë“œ ë¶€ì¡±", "bad");
    return;
  }
  state.idleLevel++;
  toast(`ìë™ ì—…ê·¸ë ˆì´ë“œ +1 (Lv ${state.idleLevel})`, "good");
  addExp(8);
  addFever(6);
  checkAchievements();
  updateUI();
}

// ---------------------- SLOT (weighted) ----------------------
const SLOT_SYMBOLS = [
  { e:"ğŸ’", w:40, onWin:()=>{ addGold(180, {silent:true}); } },
  { e:"ğŸ€", w:25, onWin:()=>{ addGold(260, {silent:true}); } },
  { e:"ğŸ”¥", w:15, onWin:()=>{ state.buffUntil = Date.now() + CONFIG.feverDurationMs; } },
  { e:"ğŸ’", w:7,  onWin:()=>{ state.gems += 4; } },
  { e:"ğŸ¾", w:12, onWin:()=>{ addExp(18); } },
  { e:"ğŸ‘‘", w:1,  onWin:()=>{ state.tickets += 3; state.gems += 2; } }
];

function pickWeighted(list){
  const total = list.reduce((s,x)=>s+x.w,0);
  let r = Math.random() * total;
  for(const it of list){
    r -= it.w;
    if(r <= 0) return it;
  }
  return list[list.length-1];
}

function spinSlot(times=1){
  const cost = (times===10) ? CONFIG.slotCostTen : CONFIG.slotCost;
  if(!spendGold(cost)){
    toast("ê³¨ë“œ ë¶€ì¡±", "bad");
    return;
  }

  let lastLine = "";
  let jackpotsHit = 0;

  for(let t=0;t<times;t++){
    state.stats.slots++;

    const a = pickWeighted(SLOT_SYMBOLS);
    const b = pickWeighted(SLOT_SYMBOLS);
    const c = pickWeighted(SLOT_SYMBOLS);
    lastLine = `${a.e} ${b.e} ${c.e}`;

    // base reward
    addExp(2);
    addFever(6);

    // win
    if(a.e===b.e && b.e===c.e){
      jackpotsHit++;
      state.stats.jackpots++;
      addGold(500, {silent:true});
      a.onWin?.();

      burst(a.e, 28);
      screenShake(220);

      if(a.e==="ğŸ‘‘"){
        showModal("JACKPOT ğŸ‘‘ğŸ‘‘ğŸ‘‘", "ëŒ€ë°•ì´ë‹¤. íŠ¹ë³„ ë³´ìƒ ì§€ê¸‰.", "+500ğŸ’° +3ğŸŸï¸ +2ğŸ’");
      }else if(a.e==="ğŸ”¥"){
        showModal("í”¼ë²„ ë¶€ìŠ¤íŠ¸ ğŸ”¥ğŸ”¥ğŸ”¥", "10ì´ˆ ë”ë¸” ë°œë™.", "+500ğŸ’° +ë”ë¸”(10ì´ˆ)");
      }else{
        toast("ë‹¹ì²¨!", "good");
      }
    }
  }

  $("slotResult").innerText = lastLine + (times===10 ? `   (10íšŒ)` : "");
  if(jackpotsHit>0) addExp(8 + jackpotsHit*3);
  checkAchievements();
  updateUI();
}

// ---------------------- GACHA (SR guarantee + SSR pity) ----------------------
function rollGachaRarity(){
  // hard pity
  if(state.gachaPity >= CONFIG.gachaPitySSR - 1) return "SSR";

  const r = Math.random() * 100;
  if(r < CONFIG.gachaRates.SSR) return "SSR";
  if(r < CONFIG.gachaRates.SSR + CONFIG.gachaRates.SR) return "SR";
  if(r < CONFIG.gachaRates.SSR + CONFIG.gachaRates.SR + CONFIG.gachaRates.R) return "R";
  return "N";
}

function animalTemplate(rarity){
  const pool = {
    N:  [{name:"ê°•ì•„ì§€", e:"ğŸ¶", cb:0.02, bb:0.02}],
    R:  [{name:"ê³ ì–‘ì´", e:"ğŸ±", cb:0.04, bb:0.04},{name:"í† ë¼", e:"ğŸ°", cb:0.05, bb:0.03}],
    SR: [{name:"í˜¸ë‘ì´", e:"ğŸ¯", cb:0.07, bb:0.08},{name:"ì—¬ìš°", e:"ğŸ¦Š", cb:0.08, bb:0.06}],
    SSR:[{name:"ë“œë˜ê³¤", e:"ğŸ²", cb:0.12, bb:0.12},{name:"ìœ ë‹ˆì½˜", e:"ğŸ¦„", cb:0.13, bb:0.10}]
  };
  const list = pool[rarity] || pool.N;
  return list[Math.floor(Math.random()*list.length)];
}

function addAnimal(rarity){
  const t = animalTemplate(rarity);
  const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
  const a = {
    id,
    rarity,
    name: t.name,
    emoji: t.e,
    clickBonus: t.cb,
    battleBonus: t.bb
  };
  state.animals.push(a);
  if(!state.equippedAnimalId) state.equippedAnimalId = a.id;
  return a;
}

function drawGacha(times=1){
  const cost = (times===10) ? CONFIG.gachaCostTen : CONFIG.gachaCost;
  if(!spendGold(cost)){
    toast("ê³¨ë“œ ë¶€ì¡±", "bad");
    return;
  }

  let textLines = [];
  let gotSSR = false;
  let gotSRorBetterInThis10 = false;

  for(let i=0;i<times;i++){
    state.stats.gachaPulls++;
    state.gachaPity++;
    state.gachaSinceSR++;

    let rarity = rollGachaRarity();

    // 10-pull SR guarantee
    if(times===10 && CONFIG.gachaGuaranteeSR10 && i===9 && !gotSRorBetterInThis10){
      if(rarity === "N") rarity = "R";
      if(rarity === "R") rarity = "SR";
    }

    if(rarity === "SR" || rarity === "SSR") gotSRorBetterInThis10 = true;

    if(rarity === "SSR"){
      gotSSR = true;
      state.gachaPity = 0;
      state.gachaSinceSR = 0;
      burst("ğŸ†", 34);
      screenShake(260);
    }else if(rarity === "SR"){
      state.gachaSinceSR = 0;
      burst("âœ¨", 20);
    }

    const a = addAnimal(rarity);
    textLines.push(`${rarity} ${a.emoji} ${a.name}`);

    addExp(rarity === "SSR" ? 35 : rarity === "SR" ? 18 : rarity === "R" ? 8 : 3);
    addFever(rarity === "SSR" ? 18 : rarity === "SR" ? 10 : 6);
  }

  $("gachaResult").innerText = textLines.join("\n");

  if(gotSSR){
    showModal("SSR íšë“!", "ì „ì„¤ê¸‰ ë™ë¬¼ì„ ì–»ì—ˆë‹¤.", "ë™ë¬¼ 1ë§ˆë¦¬ + EXP");
  }else{
    toast("ë½‘ê¸° ì™„ë£Œ", "good");
  }

  checkAchievements();
  updateUI();
}

// ---------------------- INVENTORY ----------------------
function rarityColor(r){
  if(r==="SSR") return "#ffdd57";
  if(r==="SR")  return "#9ef";
  if(r==="R")   return "#b7ffb2";
  return "#cfcfe9";
}

function renderInventory(){
  const eq = getEquipped();
  $("equippedText").innerText = eq ? `${eq.emoji} ${eq.name} (${eq.rarity})` : "ì—†ìŒ";

  if(state.animals.length === 0){
    $("inventoryList").innerText = "ë¹„ì–´ ìˆìŒ";
    return;
  }

  const html = state.animals.slice().reverse().map(a=>{
    const isEq = a.id === state.equippedAnimalId;
    return `
      <div class="achItem" style="align-items:center">
        <div>
          <div class="achName" style="color:${rarityColor(a.rarity)}">${a.emoji} ${a.name} <span style="font-size:12px;color:#a8a8c7">(${a.rarity})</span></div>
          <div class="achDesc">í´ë¦­ +${Math.round(a.clickBonus*100)}% / ì „íˆ¬ +${Math.round(a.battleBonus*100)}%</div>
        </div>
        <div class="achRight">
          <button class="smallBtn" onclick="equipAnimal('${a.id}')">${isEq ? "ì¥ì°©ì¤‘" : "ì¥ì°©"}</button>
        </div>
      </div>
    `;
  }).join("");

  $("inventoryList").innerHTML = html;
}

function equipAnimal(id){
  state.equippedAnimalId = id;
  toast("ì¥ì°© ì™„ë£Œ", "good");
  burst("ğŸ¾", 18);
  addExp(4);
  updateUI();
  renderInventory();
  checkAchievements();
}

// ---------------------- BATTLE ----------------------
function battle(){
  state.stats.battles++;

  // basic loop battle with bonuses
  let enemy = 100;
  let player = 100;

  const eq = getEquipped();
  const battleBonus = eq ? (1 + eq.battleBonus) : 1;

  $("enemyHP").style.width = "100%";
  $("battleLog").innerText = "ì „íˆ¬ ì¤‘...";

  const tick = setInterval(()=>{
    // player attack
    const dmg = 10 * battleBonus * (isBuffOn() ? 1.25 : 1);
    enemy -= dmg;

    // enemy attack
    player -= 6;

    $("enemyHP").style.width = Math.max(0, enemy) + "%";

    if(enemy <= 0 || player <= 0){
      clearInterval(tick);

      if(enemy <= 0){
        state.stats.wins++;

        const baseGold = 220;
        const bonusMult = 1 + (state.battleRewardBonus / 100);
        const winGold = Math.floor(baseGold * bonusMult);

        addGold(winGold, {silent:true});
        floatText(`+${winGold}ğŸ’°`);
        addExp(18);
        addFever(14);

        // small random drops
        const roll = Math.random();
        if(roll < 0.10){ state.tickets += 1; toast("ë“œë: ğŸŸï¸ +1", "good"); burst("ğŸŸï¸", 16); }
        else if(roll < 0.13){ state.gems += 1; toast("ë“œë: ğŸ’ +1", "good"); burst("ğŸ’", 16); }

        $("battleLog").innerText = `ìŠ¹ë¦¬! +${winGold}ğŸ’° +EXP`;
        burst("ğŸ‰", 26);
        screenShake(200);
      }else{
        $("battleLog").innerText = "íŒ¨ë°°...";
        toast("íŒ¨ë°°", "bad");
      }

      checkAchievements();
      updateUI();
    }
  }, 260);
}

// ---------------------- SHOP ----------------------
function buyCrit(){
  const cost = 500;
  if(!spendGold(cost)){ toast("ê³¨ë“œ ë¶€ì¡±", "bad"); return; }
  state.critChance = Math.min(0.35, state.critChance + 0.01);
  toast("í¬ë¦¬ í™•ë¥  ì¦ê°€", "good");
  burst("âœ¨", 16);
  addExp(10);
  addFever(10);
  checkAchievements();
  updateUI();
}

function buyFeverBoost(){
  const cost = 800;
  if(!spendGold(cost)){ toast("ê³¨ë“œ ë¶€ì¡±", "bad"); return; }
  state.feverChargeBonus = Math.min(200, state.feverChargeBonus + 20);
  toast("í”¼ë²„ ì¶©ì „ ì¦ê°€", "good");
  burst("ğŸ”¥", 18);
  addExp(12);
  checkAchievements();
  updateUI();
}

function buyBattleBoost(){
  const cost = 700;
  if(!spendGold(cost)){ toast("ê³¨ë“œ ë¶€ì¡±", "bad"); return; }
  state.battleRewardBonus = Math.min(200, state.battleRewardBonus + 10);
  toast("ì „íˆ¬ ë³´ìƒ ì¦ê°€", "good");
  burst("âš”ï¸", 14);
  addExp(12);
  checkAchievements();
  updateUI();
}

// ---------------------- ACHIEVEMENTS ----------------------
const ACH = [
  // visible achievements
  {
    id:"click_100",
    name:"ì—°íƒ€ ì…ë¬¸ì",
    desc:"í´ë¦­ 100íšŒ ë‹¬ì„±",
    hidden:false,
    reward:{ gold:300 },
    cond:()=> state.stats.clicks >= 100
  },
  {
    id:"idle_10",
    name:"ìë™í™”ì˜ ë§›",
    desc:"ìë™ ì—…ê·¸ë ˆì´ë“œ Lv 10 ë‹¬ì„±",
    hidden:false,
    reward:{ gold:600, gems:1 },
    cond:()=> state.idleLevel >= 10
  },
  {
    id:"slot_50",
    name:"ë„ë°•ì˜ ì†ë§›",
    desc:"ìŠ¬ë¡¯ 50íšŒ ëŒë¦¬ê¸°",
    hidden:false,
    reward:{ tickets:3 },
    cond:()=> state.stats.slots >= 50
  },
  {
    id:"win_10",
    name:"ì´ˆë³´ ì‚¬ëƒ¥ê¾¼",
    desc:"ì „íˆ¬ 10ìŠ¹ ë‹¬ì„±",
    hidden:false,
    reward:{ gold:800, gems:2 },
    cond:()=> state.stats.wins >= 10
  },
  {
    id:"level_10",
    name:"ì„±ì¥ ì¤‘ë…",
    desc:"ë ˆë²¨ 10 ë‹¬ì„±",
    hidden:false,
    reward:{ gold:1000, tickets:2 },
    cond:()=> state.level >= 10
  },

  // hidden achievements (??? until earned)
  {
    id:"secret_jackpot",
    name:"ì™•ê´€ì˜ ë¶€ë¦„",
    desc:"ìŠ¬ë¡¯ì—ì„œ ğŸ‘‘ğŸ‘‘ğŸ‘‘ ë‹¹ì²¨",
    hidden:true,
    reward:{ gems:5, tickets:5 },
    cond:()=> state.stats.jackpots > 0 && (lastJackpotWasCrown === true)
  },
  {
    id:"secret_crit_25",
    name:"ì¹˜ëª…íƒ€ ì¤‘ë…ì",
    desc:"í¬ë¦¬í‹°ì»¬ 25íšŒ ë‹¬ì„±",
    hidden:true,
    reward:{ gold:777 },
    cond:()=> state.stats.crits >= 25
  },
  {
    id:"secret_777_gold",
    name:"í–‰ìš´ì˜ ìˆ«ì",
    desc:"ë³´ìœ  ê³¨ë“œê°€ ì •í™•íˆ 777ì´ ë˜ëŠ” ìˆœê°„",
    hidden:true,
    reward:{ gems:3 },
    cond:()=> Math.floor(state.gold) === 777
  },
  {
    id:"secret_first_ssr",
    name:"ì „ì„¤ì˜ ì‹œì‘",
    desc:"SSR ë™ë¬¼ ì²« íšë“",
    hidden:true,
    reward:{ tickets:3, gems:2 },
    cond:()=> state.animals.some(a=>a.rarity==="SSR")
  },
  {
    id:"secret_big_spender",
    name:"í°ì†",
    desc:"ëˆ„ì  ì†Œë¹„ 50000ğŸ’° ë‹¬ì„±",
    hidden:true,
    reward:{ gems:6 },
    cond:()=> state.stats.spendTotal >= 50000
  }
];

let lastJackpotWasCrown = false;

function grantReward(reward){
  let parts = [];
  if(reward.gold){ addGold(reward.gold, {silent:true}); parts.push(`+${reward.gold}ğŸ’°`); }
  if(reward.gems){ state.gems += reward.gems; parts.push(`+${reward.gems}ğŸ’`); }
  if(reward.tickets){ state.tickets += reward.tickets; parts.push(`+${reward.tickets}ğŸŸï¸`); }
  return parts.join(" ");
}

function unlockAchievement(a){
  state.achievements[a.id] = true;

  const rewardText = a.reward ? grantReward(a.reward) : "";
  burst("ğŸ†", 26);
  screenShake(220);
  toast("ì—…ì  ë‹¬ì„±!", "good");
  showModal(`ì—…ì  ë‹¬ì„±: ${a.name}`, a.desc, rewardText);

  updateUI();
}

function checkAchievements(){
  for(const a of ACH){
    if(state.achievements[a.id]) continue;
    if(a.cond()){
      unlockAchievement(a);
    }
  }
}

function renderAchievements(){
  const html = ACH.map(a=>{
    const done = !!state.achievements[a.id];
    const name = (a.hidden && !done) ? "???" : a.name;
    const desc = (a.hidden && !done) ? "ìˆ¨ê²¨ì§„ ì—…ì " : a.desc;
    const right = done ? "ë‹¬ì„±" : (a.hidden ? "ë¹„ë°€" : "ì§„í–‰ì¤‘");
    return `
      <div class="achItem">
        <div>
          <div class="achName">${done ? "ğŸ†" : "ğŸ”’"} ${name}</div>
          <div class="achDesc">${desc}</div>
        </div>
        <div class="achRight">${right}</div>
      </div>
    `;
  }).join("");

  $("achList").innerHTML = html;
}

function renderStats(){
  $("statClicks").innerText = state.stats.clicks;
  $("statCrits").innerText = state.stats.crits;
  $("statSlots").innerText = state.stats.slots;
  $("statJackpots").innerText = state.stats.jackpots;
  $("statWins").innerText = state.stats.wins;
  $("statGoldTotal").innerText = Math.floor(state.stats.goldEarnedTotal);
}

// ---------------------- SLOT JACKPOT FLAG HOOK ----------------------
const _spinSlot = spinSlot;
spinSlot = function(times=1){
  lastJackpotWasCrown = false;

  // wrap original but detect crown jackpot within this call
  const beforeJackpots = state.stats.jackpots;
  const beforeGems = state.gems;
  _spinSlot(times);

  // detection: if jackpot increased and last visible line is crown triple
  const line = $("slotResult").innerText || "";
  if(state.stats.jackpots > beforeJackpots && line.includes("ğŸ‘‘ ğŸ‘‘ ğŸ‘‘")){
    lastJackpotWasCrown = true;
    // re-check to unlock crown secret immediately
    checkAchievements();
    if(state.gems > beforeGems) {} // no-op
  }
};

// ---------------------- DEV PANEL (7 taps + SHA-256 hash) ----------------------
// IMPORTANT: replace with your sha256("your_password") hex string
const ADMIN_HASH = "abd3f2ed90f684b305ed7632ee24e58ed439de9158399ce9a5952281ef804b43";

let __logoTap = 0;

async function sha256Hex(str){
  const data = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", data);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function openAdminGate(){
  const pw = prompt("Admin password");
  if(!pw) return;
  const h = await sha256Hex(pw);
  if(h === ADMIN_HASH){
    sessionStorage.setItem("isAdmin","1");
    $("devPanel").classList.remove("hidden");
    go("devPanel");
    toast("Admin enabled", "good");
    burst("âœ¨", 18);
  }else{
    toast("Access denied", "bad");
    screenShake(140);
  }
}

$("logo").addEventListener("click", async ()=>{
  __logoTap++;
  if(__logoTap >= 7){
    __logoTap = 0;
    await openAdminGate();
  }
});

if(sessionStorage.getItem("isAdmin")==="1"){
  $("devPanel").classList.remove("hidden");
}

// ---------------------- CHEATS ----------------------
function cheatAddGold(v){ addGold(v); }
function cheatAddGems(v){ state.gems += v; updateUI(); }
function cheatAddTickets(v){ state.tickets += v; updateUI(); }
function cheatForceJackpot(){
  $("slotResult").innerText = "ğŸ‘‘ ğŸ‘‘ ğŸ‘‘";
  state.stats.slots++;
  state.stats.jackpots++;
  lastJackpotWasCrown = true;
  addGold(1500);
  state.tickets += 5;
  state.gems += 5;
  burst("ğŸ‘‘", 34);
  screenShake(240);
  checkAchievements();
  updateUI();
}
function cheatForceSSR(){
  const a = addAnimal("SSR");
  $("gachaResult").innerText = `SSR ${a.emoji} ${a.name}`;
  burst("ğŸ†", 34);
  screenShake(260);
  addExp(40);
  checkAchievements();
  updateUI();
}
function cheatReset(){
  if(!confirm("ì§„ì§œ ì´ˆê¸°í™”?")) return;
  localStorage.removeItem("casinoV2_full");
  location.reload();
}

// ---------------------- DOUBLE TAP ZOOM PREVENT (iOS) ----------------------
let lastTouch = 0;
document.addEventListener("touchend", (e)=>{
  const now = Date.now();
  if(now - lastTouch <= 300){
    e.preventDefault();
  }
  lastTouch = now;
}, {passive:false});

// ---------------------- GAME LOOP ----------------------
setInterval(()=>{
  // idle income tick (10 per sec)
  const gain = getIdleIncome() / 10;
  if(gain > 0){
    addGold(gain, {silent:true});
    // tiny exp from idle (low)
    state.exp += 0.02;
    // level check occasionally
    if(Math.random() < 0.1) addExp(0); // triggers level check sometimes
  }

  // fever background vibe
  if(isBuffOn()){
    document.body.style.background = "radial-gradient(900px 520px at 50% -10%, #3a1266 0%, #0d0d18 60%)";
  }else{
    document.body.style.background = "#0d0d18";
  }

  // periodic checks & save
  checkAchievements();
  updateUI();
  save();
}, 100);

// initial render
updateUI();
renderAchievements();
renderStats();
</script>

</body>
</html>

